<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Jejak Iman merupakan blog yang menceritakan tentang Islam dalam kehidupan seharian.">
    <meta content="Jejak Iman" property="og:title">
    <meta property="og:type" content="website">
    <meta content="https://jejakiman.pages.dev/images/logo.png" property="og:image">
    <meta property="og:url" content="https://jejakiman.pages.dev/carian.html">
    <title>Jejak Iman: Perjalananku dengan Islam</title>
    <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
  <link href="/css/phone-style.css" rel="stylesheet" type="text/css">
    <link rel="icon" href="/images/logo.png" type="image/png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/lunr/lunr.min.js"></script>
  <script src="/javascript/include.js"></script>
  <script src="/javascript/scripts.js"></script>

  <style>
    :root { --maxw: 820px; --radius: 10px; --gap: 12px; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Helvetica Neue", Arial, "Noto Sans", sans-serif,
                   "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0; padding: 32px 16px; line-height: 1.6;
      color: #24292f; background: #fff;
    }
    .container { max-width: var(--maxw); margin: 0 auto; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .searchbar {
      display: flex; gap: 8px; align-items: center; margin-bottom: 12px;
    }
    #q {
      width: 100%; padding: 10px 12px; font-size: 16px;
      border: 1px solid #d0d7de; border-radius: var(--radius);
      outline: none;
    }
    #q:focus { border-color: #0969da; box-shadow: 0 0 0 3px rgba(9,105,218,0.15); }
    .hint { font-size: 13px; color: #57606a; margin-bottom: 18px; }
    .result {
      border: 1px solid #d0d7de; border-radius: var(--radius);
      padding: 12px; margin-bottom: var(--gap);
    }
    .result a { color: #0969da; text-decoration: none; }
    .result a:hover { text-decoration: underline; }
    .snippet { margin-top: 6px; color: #484f58; font-size: 15px; }
    mark { background: #fff8c5; padding: 0 2px; border-radius: 2px; }
    .empty { color: #6e7781; padding: 12px 0; }
  </style>
  </head>
  <body>
  <main class="container">
    <h1>Search</h1>
    <div class="searchbar">
      <input id="q" type="search" placeholder="Taip di sini…" aria-label="Search" autocomplete="off" />
    </div>
    <div id="hint"></div>
    <div id="results"></div>
  </main>

  <script>
    // Utilities
    const escapeHTML = (s) => s.replace(/[&<>"']/g, (c) =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
    );

    const byId = (id) => document.getElementById(id);

    const resultsEl = byId('results');
    const inputEl = byId('q');

    let idx = null;
    let docs = [];

    // Initialize: load documents and build the index
    async function init() {
      const res = await fetch('/index.json', { cache: 'no-store' });
      docs = await res.json();

      idx = lunr(function () {
        this.ref('id');
        this.field('tajuk', { boost: 8 });
        this.field('tag',  { boost: 4 });
        this.field('kandungan');

        // Store match positions so we can make highlighted snippets.
        // (See Lunr customisation docs on metadataWhitelist / positions)
        this.metadataWhitelist = ['position'];

        // Because Jejak Iman may include Malay text, disable English-only stemming/stopwords
        // so Malay words are not mangled. If your content is mostly English, you can remove
        // these lines to get English stemming back.
        this.pipeline.remove(lunr.stemmer);
        this.searchPipeline.remove(lunr.stemmer);
        this.pipeline.remove(lunr.stopWordFilter);
        this.searchPipeline.remove(lunr.stopWordFilter);

        docs.forEach(doc => this.add(doc));
      });

      inputEl.addEventListener('input', () => runSearch(inputEl.value));
      inputEl.focus();
    }

    function runSearch(raw) {
      const q = raw.trim();
      if (!q) { resultsEl.innerHTML = '<div class="empty">Taip dulu, nanti akan ada senarai catatan, Insha-Allah.</div>'; return; }

      // Sanitize lunr special chars and build a friendly query:
      // exact term + prefix wildcard + fuzzy (edit distance 1)
      const safe = q.replace(/[+\-:~^*"]/g, ' ');
      const query = `${safe} ${safe}* ${safe}~1`;

      let hits = [];
      try {
        hits = idx.search(query);
      } catch (e) {
        // If the user types something lunr cannot parse, fall back to plain term
        try { hits = idx.search(safe); } catch (e2) { hits = []; }
      }

      renderResults(hits);
    }

    function renderResults(hits) {
      if (!hits.length) { resultsEl.innerHTML = '<div class="empty">Tidak dijumpai. Cuba taip benda lain. Hah gitu…</div>'; return; }

      const html = hits.map(hit => {
        const doc = docs.find(d => d.id === hit.ref);
        const snippet = makeSnippet(doc, hit);
        const score = hit.score.toFixed(3);
        return `
          <article class="result">
            <a href="${doc.url}"><strong>${escapeHTML(doc.tajuk)}</strong></a>
            <div class="snippet">${snippet}</div>
          </article>`;
      }).join('');

      resultsEl.innerHTML = html;
    }

    // Build a highlighted snippet using match positions (if available).
    function makeSnippet(doc, hit) {
      const md = hit.matchData && hit.matchData.metadata ? hit.matchData.metadata : {};
      const positions = [];

      for (const term in md) {
        const fields = md[term];
        if (fields.content && Array.isArray(fields.kandungan.position)) {
          positions.push(...fields.kandungan.position);
        }
      }

      // Sort positions by start index
      positions.sort((a, b) => a[0] - b[0]);

      const text = doc.kandungan || '';
      if (!text) return '';

      const SNIPPET = 160;

      if (positions.length === 0) {
        // Fallback: just show the start of content
        const safe = escapeHTML(text.slice(0, SNIPPET));
        return safe + (text.length > SNIPPET ? '…' : '');
      }

      // Use the first match to center the snippet
      const [start, len] = positions[0];
      const from = Math.max(0, start - 40);
      const to   = Math.min(text.length, start + len + 90);
      const slice = text.slice(from, to);

      // Highlight all matches that fall within the slice
      const within = positions.filter(([s, l]) => s >= from && s < to)
                              .sort((a, b) => a[0] - b[0]);

      let out = '';
      let last = 0;
      for (const [s, l] of within) {
        const rel = s - from;
        out += escapeHTML(slice.slice(last, rel));
        out += '<mark>' + escapeHTML(slice.slice(rel, rel + l)) + '</mark>';
        last = rel + l;
      }
      out += escapeHTML(slice.slice(last));

      const lead = (from > 0) ? '…' : '';
      const tail = (to < text.length) ? '…' : '';
      return lead + out + tail;
    }

    // Boot
    init();
  </script>
  </body>
</html>
